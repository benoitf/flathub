app-id: io.podman_desktop.PodmanDesktop
runtime: org.freedesktop.Platform
runtime-version: "21.08"
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: "21.08"
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node16
command: run.sh
separate-locales: false
finish-args:
  - "--socket=session-bus"
  - "--socket=wayland"
  - "--socket=x11"
  - "--share=ipc"
  - "--device=dri"
  - "--filesystem=home"
  - "--filesystem=xdg-run/podman"
  - "--share=network"
  - "--talk-name=org.freedesktop.Notifications"
build-options:
  append-path: /usr/lib/sdk/node16/bin
modules:
  # needs yarn to build the project
  - name: yarn
    buildsystem: simple
    build-commands:
      - "cp -a * /app"
    # Only used for building, so clean it up afterwards.
    cleanup:
      - "*"
    sources:
      - type: archive
        url: https://github.com/yarnpkg/yarn/releases/download/v1.22.19/yarn-v1.22.19.tar.gz
        sha256: 732620bac8b1690d507274f025f3c6cfdc3627a84d9642e38a07452cc00e0f2e
  # convert icon for all sizes
  - name: ImageMagick
    config-opts:
      - "--disable-static"
      - "--disable-docs"
      - "--with-pic"
    cleanup:
      - "*"
    sources:
      - type: archive
        url: https://github.com/ImageMagick/ImageMagick/archive/7.1.0-45.tar.gz
        sha256: 3df6ca6dff15a4e8a20b4593c60285a59e38890440494d91a344e5c0e2bb3eec
  # Podman Desktop sources
  - name: podman-desktop
    buildsystem: simple
    build-options:
      env:
        XDG_CACHE_HOME: /run/build/podman-desktop/flatpak-node/cache
        YARN_CACHE_FOLDER: /run/build/podman-desktop/flatpak-node/yarn-cache
    build-commands:
      # Display tooling version
      - node --version
      - yarn --version
      # configure mirror to use the one generated by generated-sources.json artifacts
      - echo "yarn-offline-mirror $FLATPAK_BUILDER_BUILDDIR/flatpak-node/yarn-mirror" > .yarnrc
      # install in offline mode (all steps need to use offline with flatpak)
      - yarn --offline install
      # compile the app
      - MODE=production yarn --offline run build
      # Build electron app
      - MODE=production $(npm bin)/electron-builder build --config .electron-builder.config.js --linux --dir
      # Bundle app and dependencies
      - cp -a dist/linux*unpacked /app/main
      # add icons
      - for s in {32,64,128,256,512}; do
        convert "buildResources/icon.png" -resize "${s}" "${FLATPAK_ID}.png";
        echo "generating ${FLATPAK_ID}.png";
        ls -la "${FLATPAK_ID}.png";
        install -p -Dm644 "${FLATPAK_ID}.png" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
        done;
        # add scalable svg icon
      - install -p -Dm644 "buildResources/icon.svg" -t "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg";
      - install -p -Dm644 "buildResources/icon.svg" -t "${FLATPAK_DEST}/share/app-info/icons/flatpak/scalable/${FLATPAK_ID}.svg";
      # add metainfo
      - install -Dm644 .flatpak-appdata.xml "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml";
      # add desktop file
      - install -Dm644 ${FLATPAK_ID}.desktop /app/share/applications/${FLATPAK_ID}.desktop
      # Install run script
      - install -Dm755 -t /app/bin/ run.sh
    sources:
      - type: archive
        url: https://github.com/containers/podman-desktop/archive/refs/tags/v0.0.6.tar.gz
        sha256: 40b1668a5d75413d86694b8c797cb2fe1b069d1d09ddf6d0be2c77634a221d1f
      - type: file
        path: io.podman_desktop.PodmanDesktop.desktop
      - type: script
        dest-filename: run.sh
        commands:
          # Wrapper to launch the app
          - export TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID"
          - zypak-wrapper.sh /app/main/podman-desktop "$@"
      - generated-sources.json
